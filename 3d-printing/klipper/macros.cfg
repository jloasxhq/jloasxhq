# ==========================================
# Klipper Macros for Creality Printers
# Author: Josh Merritt
# Last Updated: January 2026
# ==========================================
#
# Include this file in your printer.cfg:
# [include macros.cfg]
#
# ==========================================

# ==========================================
# START_PRINT Macro
# ==========================================
# Usage in slicer start G-code:
# START_PRINT BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp}

[gcode_macro START_PRINT]
description: Start print preparation
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(200)|float %}

    # Reset state
    G90                                      ; Absolute positioning
    M82                                      ; Absolute extrusion
    G92 E0                                   ; Reset extruder

    # Start heating bed
    M117 Heating bed...
    M140 S{BED_TEMP}                         ; Set bed temp (no wait)

    # Preheat nozzle to prevent ooze during leveling
    M104 S150                                ; Set nozzle to 150°C

    # Home all axes
    M117 Homing...
    G28                                      ; Home all axes

    # Wait for bed temperature
    M117 Waiting for bed...
    M190 S{BED_TEMP}                         ; Wait for bed temp

    # Bed mesh (if available)
    {% if printer.configfile.settings.bed_mesh is defined %}
        M117 Bed mesh...
        BED_MESH_CALIBRATE ADAPTIVE=1        ; Adaptive mesh
    {% endif %}

    # Heat nozzle to print temperature
    M117 Heating nozzle...
    M109 S{EXTRUDER_TEMP}                    ; Wait for nozzle temp

    # Prime line
    M117 Priming...
    G92 E0                                   ; Reset extruder
    G1 Z2.0 F3000                           ; Move Z up
    G1 X0.1 Y20 Z0.3 F5000.0                ; Move to start
    G1 X0.1 Y200.0 Z0.3 F1500.0 E15         ; Draw first line
    G1 X0.4 Y200.0 Z0.3 F5000.0             ; Move to side
    G1 X0.4 Y20 Z0.3 F1500.0 E30            ; Draw second line
    G92 E0                                   ; Reset extruder
    G1 Z5.0 F3000                           ; Lift Z

    # Ready to print
    M117 Printing...

# ==========================================
# END_PRINT Macro
# ==========================================
# Usage in slicer end G-code:
# END_PRINT

[gcode_macro END_PRINT]
description: End print cleanup
gcode:
    # Calculate safe Z position
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set current_z = printer.toolhead.position.z|float %}
    {% set z_safe = [current_z + 10.0, max_z]|min %}

    # Retract filament
    G91                                      ; Relative positioning
    G1 E-5 F1800                            ; Retract 5mm
    G1 Z10 F3000                            ; Raise Z 10mm

    # Present print
    G90                                      ; Absolute positioning
    {% set max_y = printer.toolhead.axis_maximum.y|float %}
    G1 X0 Y{max_y - 5} F6000                ; Move bed forward

    # Turn off heaters
    M117 Cooling down...
    TURN_OFF_HEATERS

    # Part cooling (optional)
    M106 S255                                ; Fan to 100%
    G4 P30000                                ; Wait 30 seconds
    M106 S0                                  ; Fan off

    # Disable steppers
    M84 X Y E                                ; Disable X, Y, E motors

    # Display complete message
    M117 Print Complete!

# ==========================================
# PAUSE Macro
# ==========================================

[gcode_macro PAUSE]
description: Pause the print
rename_existing: PAUSE_BASE
gcode:
    # Save current state
    SAVE_GCODE_STATE NAME=PAUSE_STATE

    # Pause
    PAUSE_BASE

    # Park toolhead
    {% set x_park = printer.toolhead.axis_minimum.x + 5 %}
    {% set y_park = printer.toolhead.axis_maximum.y - 5 %}
    {% set z_park = [printer.toolhead.position.z + 10, printer.toolhead.axis_maximum.z]|min %}

    G91                                      ; Relative positioning
    G1 E-3 F2700                            ; Retract 3mm
    G90                                      ; Absolute positioning
    G1 X{x_park} Y{y_park} Z{z_park} F6000  ; Park

    M117 Paused

# ==========================================
# RESUME Macro
# ==========================================

[gcode_macro RESUME]
description: Resume the print
rename_existing: RESUME_BASE
gcode:
    # Prime before resume
    G91                                      ; Relative positioning
    G1 E3 F2700                             ; Prime 3mm
    G90                                      ; Absolute positioning

    # Restore state and resume
    RESTORE_GCODE_STATE NAME=PAUSE_STATE MOVE=1 MOVE_SPEED=100
    RESUME_BASE

    M117 Printing...

# ==========================================
# CANCEL_PRINT Macro
# ==========================================

[gcode_macro CANCEL_PRINT]
description: Cancel the print
rename_existing: CANCEL_PRINT_BASE
gcode:
    # Turn off heaters
    TURN_OFF_HEATERS

    # Clear pause state
    CLEAR_PAUSE

    # Cancel base
    CANCEL_PRINT_BASE

    # Run end print cleanup
    END_PRINT

# ==========================================
# M600 - Filament Change
# ==========================================

[gcode_macro M600]
description: Filament change
gcode:
    # Pause print
    PAUSE

    # Additional retraction for filament change
    G91
    G1 E-50 F1000                           ; Retract 50mm for filament removal
    G90

    M117 Change Filament

# ==========================================
# LOAD_FILAMENT Macro
# ==========================================

[gcode_macro LOAD_FILAMENT]
description: Load filament
gcode:
    {% set TEMP = params.TEMP|default(200)|float %}

    # Heat nozzle
    M117 Heating...
    M109 S{TEMP}

    # Load filament
    M117 Loading...
    G91
    G1 E50 F300                             ; Extrude 50mm slowly
    G1 E25 F150                             ; Extrude 25mm very slowly
    G90
    G92 E0

    M117 Filament Loaded

# ==========================================
# UNLOAD_FILAMENT Macro
# ==========================================

[gcode_macro UNLOAD_FILAMENT]
description: Unload filament
gcode:
    {% set TEMP = params.TEMP|default(200)|float %}

    # Heat nozzle
    M117 Heating...
    M109 S{TEMP}

    # Unload filament
    M117 Unloading...
    G91
    G1 E10 F300                             ; Prime a little
    G1 E-50 F1000                           ; Retract 50mm fast
    G1 E-30 F500                            ; Retract 30mm slower
    G90
    G92 E0

    M117 Filament Unloaded

# ==========================================
# PID Calibration Macros
# ==========================================

[gcode_macro PID_EXTRUDER]
description: PID tune extruder
gcode:
    {% set TEMP = params.TEMP|default(200)|float %}
    M117 PID tuning extruder...
    PID_CALIBRATE HEATER=extruder TARGET={TEMP}
    M117 PID complete - SAVE_CONFIG

[gcode_macro PID_BED]
description: PID tune bed
gcode:
    {% set TEMP = params.TEMP|default(60)|float %}
    M117 PID tuning bed...
    PID_CALIBRATE HEATER=heater_bed TARGET={TEMP}
    M117 PID complete - SAVE_CONFIG

# ==========================================
# Calibration Macros
# ==========================================

[gcode_macro CALIBRATE_ESTEPS]
description: Extrude 100mm for E-steps calibration
gcode:
    {% set TEMP = params.TEMP|default(200)|float %}

    M117 Heating...
    M109 S{TEMP}

    M117 Mark filament at 120mm!
    G4 P5000                                 ; Wait 5 seconds

    M117 Extruding 100mm...
    G91
    G1 E100 F100
    G90

    M117 Measure remaining distance

[gcode_macro TEST_SPEED]
description: Test print speed
gcode:
    {% set SPEED = params.SPEED|default(100)|float %}
    {% set ACCEL = params.ACCEL|default(3000)|float %}

    # Set speed/accel
    SET_VELOCITY_LIMIT VELOCITY={SPEED} ACCEL={ACCEL}

    # Home
    G28

    # Test pattern
    G1 X50 Y50 F{SPEED * 60}
    G1 X200 Y50
    G1 X200 Y200
    G1 X50 Y200
    G1 X50 Y50
    G1 X200 Y200
    G1 X50 Y200
    G1 X200 Y50
    G1 X125 Y125

    M117 Speed test complete

# ==========================================
# Utility Macros
# ==========================================

[gcode_macro G29]
description: Bed leveling (compatibility)
gcode:
    BED_MESH_CALIBRATE

[gcode_macro M420]
description: Enable/disable bed mesh (compatibility)
gcode:
    {% set S = params.S|default(1)|int %}
    {% if S == 1 %}
        BED_MESH_PROFILE LOAD=default
    {% else %}
        BED_MESH_CLEAR
    {% endif %}

[gcode_macro DISABLE_MOTORS]
description: Disable all motors
gcode:
    M84

[gcode_macro PREHEAT_PLA]
description: Preheat for PLA
gcode:
    M140 S60                                 ; Bed to 60°C
    M104 S200                                ; Nozzle to 200°C
    M117 Preheating PLA...

[gcode_macro PREHEAT_PETG]
description: Preheat for PETG
gcode:
    M140 S80                                 ; Bed to 80°C
    M104 S230                                ; Nozzle to 230°C
    M117 Preheating PETG...

[gcode_macro PREHEAT_ABS]
description: Preheat for ABS
gcode:
    M140 S100                                ; Bed to 100°C
    M104 S240                                ; Nozzle to 240°C
    M117 Preheating ABS...

[gcode_macro COOLDOWN]
description: Turn off all heaters
gcode:
    TURN_OFF_HEATERS
    M106 S0                                  ; Fan off
    M117 Cooling down...

# ==========================================
# Beeper Macro
# ==========================================

[gcode_macro BEEP]
description: Play a beep sound
gcode:
    {% set FREQ = params.FREQ|default(1000)|int %}
    {% set DUR = params.DUR|default(100)|int %}
    {% if printer['output_pin beeper'] is defined %}
        SET_PIN PIN=beeper VALUE=0.5 CYCLE_TIME={1.0/FREQ}
        G4 P{DUR}
        SET_PIN PIN=beeper VALUE=0
    {% endif %}

# ==========================================
# End of macros.cfg
# ==========================================
